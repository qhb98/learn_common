## 模拟退火算法 simulated annealing, SA

### 一、基本概念

来源于固体退火原理, 是一种基于概率的算法.

算法的基本思想: 先从一个较高的初始温度出发, 逐渐降低温度, 直到温度降低到满足热平衡条件为止.
在每个温度下, 进行n轮搜索, 每轮搜索时对旧解添加随机扰动生成新解, 并按一定规则接受新解.

本质是双层循环, 外层循环控制温度由高向低变化, 温度计算公式为取值在[0, 1]上的温度衰减系数; 内层循环中, 温度固定,
对旧解添加随机扰动得到新解, 并按照一定规则接受新解. 内层循环的迭代次数称为马尔科夫链长度.

模拟退火算法的关键点在于 对较差的旧解的处理上. 在任一温度时, 对初始解添加随机扰动产生新解, 若新解的目标函数值优于旧解,
则接受新解; 若新解差于旧解, 则按一定概率接受旧解, 从而有一定概率跳出局部最优解, 找到全局最优解.
这个根据一定概率选择是否接受差解的方法叫做Metropolos准则

### 二、改进点

1. 初始温度和马尔科夫链长度的设置问题
   初始温度越高，且马尔科夫链越长，算法搜索越充分，得到全局最优解的可能性越大，但这也意味着需要耗费更多的计算时间
2. 退火速度问题
   温度衰减系数越小，温度下降越快，对应的迭代次数也就越少，算法搜索的次数也就越少

关键参数是马尔科夫链长度和温度衰减系数，马尔科夫链越长，且温度衰减系数越接近于1，
模拟退火算法搜索越充分，越有可能找到全局最优解，但相应地也会增加算法搜索时间.
当解空间的维度较高时，模拟退火算法要想搜索到全局最优解需要耗费大量时间，
这是模拟退火算法的一个主要缺点

### 三、tips

1. 初始解的产生
   模拟退火算法是在可行解的邻域内添加随机扰动产生新解，所以务必确保初始解是一个可行解
2. 随机扰动的大小
   随机扰动的数值大小决定了算法每次搜索的步长，若扰动太大，容易步子迈大扯着蛋，难以搜索到全局最优解
3. 约束条件的限制
   不同的问题有不同的约束条件，注意检查新解是否满足约束条件，若不满足约束则要针对性地进行修改
4. 模拟退火算法的初始参数

### 四、算法流程

    step1 设定初始温度 t0 = t_max, 任选初始解 r = r0, 每个T值的迭代次数L.
    step2 while k=1,2,...,L
        step2.1 从 r 的邻域中随机选择一个解 r_t, 计算 r 和 r_t 对应的目标函数值, 如果r_t对应的目标函数值较小, 
        则令 r = r_t, 否则若 exp(-E(r_t) - E(r) / t) > random(0, 1), 则令 r = r_t.
        模拟退火算法就是通过Metropolis准则按照一定的概率去接受坏解, 从而使得最终解在一定概率下可以跳出局部最优, 
        寻找到全局最优解.  
        step2.2 满足内循环停止条件(1.目标函数均值稳定, 2.连续若干步的目标值变化较小, 3.固定的抽样步数)时, 否则重复step2.1.
    step3 外循环
        step3.1 降温 t= decrease(t)
        step3.2 如果不满足外循环停止条件, 则转step2(1.达到终止温度, 2.达到迭代次数, 3.最优值连续若干步保持不变), 
        否则算法结束.

状态产生函数(邻域函数):  
尽可能保证产生的候选解遍布全部解空间, 包括两个部分内容: 产生候选解的方式、候选解产生的概率分布.  
候选解的产生方式由问题的性质决定, 通常在当前状态的邻域结构内以一定概率方式产生, 而邻域函数和概率方式可以多样化设计,
均匀分布、正太分布等.

状态接受函数:  
目的是尽可能接受优化解, 一般以概率的方式给出, 不同接受函数的差别主要在于接受概率的形式不同.  
设计状态接受概率应该遵循的原则:
固定温度下, 接受使目标函数值下降的候选解的概率要大于使目标函数值上升的候选解的概率.  
随温度的下降, 接受使目标函数值上升的解的概率要逐渐减小.  
当温度趋于0, 只能接受目标函数值下降的解.

初温:  
初温值只要选择充分大, 获得高质量解的概率就大. 但需要的计算耗时就会增加.  
初温的确定应折衷考虑优化质量和优化效率:  
+ 均匀抽样一组状态, 选择各状态目标值的方差  
+ 随机产生一组状态, 确定两两状态间的最大目标值差, 然后依据差值, 利用一定的函数确定初温

温度更新函数:  
衰减量 以小为宜  
Kirkpatrick认为衰减系数应该取值0.95, Lutton认为应该采用[0.5, 0.99].

### 五、Metropolis准则

在温度为T时, 接受能量从 E(x_old) 到 E(x_new) 的概率为P:  
p = 1, if E(x_old) > E(x_new)  
p = exp(- (E(x_new) - E(x_old)) / T), if E(x_old) <= E(x_new)

Metropolis算法就是如何在局部最优解的情况下让其跳出来，是退火的基础

### 六、改进

1. 模拟退火在求解规模较大的实际问题时, 往往存在 收敛速度过慢, 无法判定是否处于平衡状态, 无法保证解是全局最优等缺点.
2. 并行模拟退火算法、快速模拟退火算法（Cauchy机）
3. 记录“Best so far”状态，并即时更新
4. 设置双阈值，使得在尽量保持最优性的前提下减少计算量，即在各温度下当前状态连续 m1 步保持不变则认为Metropolis抽样稳定
   若连续 m2 次退温过程中所得最优解不变则认为算法收敛
5. 时间不变的噪声算法（TINA Time-invariant noise algorithm） 状态产生函数中扰动强度不随时间改变，
   而是和能量大小相关，能量大的扰动大，能量小的扰动小，能量为零，扰动也为零，算法停止
6. 记忆指导SA(Simulated Annealing with Memmory Guidance ,简记为SAMG) 增加一个记忆装置
   存储算法计算过程产生的最好的解，以这个解为最终解
7. 自适应SA算法 根据邻域搜索进展的反馈信息, 自适应确定温度变化和邻域搜索强度
    1) 退火过程中温度参数变化符合幅值递减的下降总趋势, 但不排除局部升温的可能, 以保证寻求到合适的温度序列, 避免陷入局部最优;
    2) 算法的终止条件依据退火温度和邻域搜索进展状态设计;
    3) 每一温度下算法的迭代次数随温度下降而递增, 邻域搜索强度依其对目标函数的贡献动态分配;
    4) 温度变化、邻域搜索和终止条件的控制机制由算法过程自动触发

### 参考资料:

https://zhuanlan.zhihu.com/p/104538819  


